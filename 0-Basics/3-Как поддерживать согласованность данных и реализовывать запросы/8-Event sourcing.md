Паттерн "Событийное хранение" (Event Sourcing) предлагает подход к управлению состоянием бизнес-объектов, сохраняя все изменения состояния в виде последовательности событий.

## Контекст

При выполнении команд сервису необходимо создавать, обновлять или удалять агрегаты в базе данных и отправлять сообщения в брокер сообщений. Это особенно важно для сервисов, участвующих в сагах или публикующих доменные события. Однако использование традиционных распределенных транзакций (2PC) часто нежелательно из-за сложности и недостаточной поддержки со стороны баз данных и брокеров.

## Проблема

Ключевая задача заключается в том, как атомарно обновить базу данных и отправить сообщения в брокер сообщений, сохраняя при этом порядок отправки сообщений.

## Решение

Паттерн "Событийное хранение" решает эту проблему путем сохранения состояния бизнес-объектов как последовательности событий. Когда состояние изменяется, новое событие добавляется в хранилище событий. Это обеспечивает атомарность операции, так как запись события происходит как единое целое. Текущее состояние объекта восстанавливается путем воспроизведения событий из хранилища.

## Пример

Примером применения является система управления заказами и клиентами, использующая Java и Spring Boot. Вместо хранения текущего состояния заказа в таблице, система сохраняет каждый заказ как последовательность событий. Сервис клиентов может подписываться на события заказов и обновлять свое состояние.

```
public class Order {
	private OrderState state;
	private String customerId;
	
	public List<Event> process(CreateOrderCommand cmd) {
		return EventUtil.events(new OrderCreatedEvent(cmd.getCustomerId(), cmd.getOrderTotal()));
	}
	
	public void apply(OrderCreatedEvent event) {
		this.state = OrderState.CREATED;
		this.customerId = event.getCustomerId();
	}
}
```

## Преимущества

- Надежная публикация событий при изменении состояния.
- Избежание проблемы несоответствия объектов и реляционных данных.
- Полный аудит изменений бизнес-объектов.
- Возможность временных запросов для определения состояния объекта в любой момент времени.
- Упрощение миграции от монолитных приложений к микросервисной архитектуре.

## Недостатки

- Необходимость освоения нового стиля программирования.
- Сложность запросов к хранилищу событий, что требует использования паттерна CQRS для реализации запросов.

## Связанные паттерны

- Паттерны "Сага" и "Доменные события" создают необходимость в использовании событийного хранения.
- Часто используется с паттерном CQRS.
- Реализует паттерн аудита изменений.

Этот паттерн позволяет эффективно управлять состоянием объектов в микросервисной архитектуре, но требует внимательного подхода к проектированию и реализации.

[Ссылка на источник](https://microservices.io/patterns/data/event-sourcing.html)