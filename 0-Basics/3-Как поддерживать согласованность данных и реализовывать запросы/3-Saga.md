Паттерн **"Сага"** (Saga) используется для управления транзакциями, которые охватывают несколько микросервисов, особенно в контексте применения паттерна **"База данных на сервис"**. Он позволяет обеспечить согласованность данных без необходимости использования распределённых транзакций.

## Основные аспекты паттерна:

- **Локальные транзакции**: Каждая бизнес-транзакция, охватывающая несколько сервисов, реализуется как последовательность локальных транзакций. Каждая локальная транзакция обновляет свою базу данных и публикует сообщение или событие для запуска следующей локальной транзакции.
- **Компенсационные транзакции**: Если одна из локальных транзакций не выполняется, срабатывают компенсирующие транзакции для отмены изменений, сделанных предыдущими локальными транзакциями.

## Способы координации:

1. **Хореография (Choreography)**: Каждый сервис публикует события домена, которые инициируют локальные транзакции в других сервисах.
2. **Оркестрация (Orchestration)**: Специальный объект-оркестратор управляет последовательностью выполнения локальных транзакций.

## Примеры:

- **Хореография**: В e-commerce приложении процесс создания заказа может выглядеть следующим образом:
    
    - `Order Service` получает запрос на создание заказа и создает заказ в состоянии `PENDING`.
    - Он публикует событие `Order Created`.
    - Обработчик событий в `Customer Service` пытается зарезервировать кредит и публикует результат.
    - В зависимости от результата `Order Service` либо подтверждает, либо отклоняет заказ.
    
- **Оркестрация**: В этом подходе процесс будет следующим:
    
    - `Order Service` получает запрос и создает оркестратор для обработки создания заказа.
    - Оркестратор создает заказ в состоянии `PENDING` и отправляет команду на резервирование кредита в `Customer Service`.
    - После получения ответа от `Customer Service`, оркестратор принимает решение о подтверждении или отклонении заказа.
    

## Преимущества:

- Поддержание согласованности данных между несколькими сервисами без использования распределённых транзакций.

## Недостатки:

- **Отсутствие автоматического отката**: Необходимо явно проектировать компенсирующие транзакции.
- **Отсутствие изоляции**: Конкурирующие транзакции могут привести к аномалиям данных, требуя дополнительных мер предосторожности.

## Связанные паттерны:

- Паттерн "База данных на сервис" создает необходимость в использовании саг.
- Другие подходы к атомарному обновлению состояния и публикации сообщений включают использование агрегатов и событий домена.

Таким образом, паттерн "Сага" является важным инструментом для обеспечения согласованности данных в распределённых системах, позволяя управлять сложными бизнес-транзакциями между микросервисами.

[Ссылка на источник](https://microservices.io/patterns/data/saga.html)