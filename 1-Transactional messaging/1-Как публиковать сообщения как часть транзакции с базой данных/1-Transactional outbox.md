Паттерн "Транзакционный выходной ящик" (Transactional Outbox) предлагает решение для атомарного обновления базы данных и отправки сообщений в брокер сообщений в микросервисной архитектуре.

## Контекст

Сервисы часто нуждаются в одновременном обновлении бизнес-объектов и отправке событий. Например, при участии в саге или публикации доменных событий необходимо обеспечить согласованность между изменениями в базе данных и отправкой сообщений. Использование традиционных распределенных транзакций (2PC) нежелательно из-за сложности и ограниченной поддержки со стороны баз данных и брокеров сообщений.

## Проблема

Ключевая задача заключается в том, как атомарно обновить базу данных и отправить сообщения, сохраняя порядок их отправки.

## Решение

Решение состоит в том, чтобы сначала сохранить сообщение в базе данных как часть транзакции, обновляющей бизнес-объекты. Затем отдельный процесс (или компонент) отправляет эти сообщения в брокер сообщений.

## Участники паттерна:

- **Отправитель** — сервис, который отправляет сообщение.
- **База данных** — хранит бизнес-объекты и выходной ящик сообщений.
- **Выходной ящик сообщений** — таблица в реляционной базе данных или свойство записи в NoSQL базе данных, где хранятся сообщения для отправки.
- **Реле сообщений** — компонент, который отправляет сообщения из выходного ящика в брокер сообщений.

## Результаты

## Преимущества

- Исключение необходимости использования 2PC.
- Гарантия отправки сообщений только при успешном коммите транзакции базы данных.
- Сохранение порядка отправки сообщений.

## Недостатки

- Возможность ошибок, если разработчик забудет опубликовать сообщение после обновления базы данных.
- Реле сообщений может публиковать одно и то же сообщение несколько раз, если оно завершает работу после публикации, но до записи факта публикации. Это требует от потребителей сообщений реализации идемпотентности.

## Связанные паттерны

- Паттерны "Сага" и "Доменные события" создают необходимость в использовании паттерна "Транзакционный выходной ящик".
- Паттерн "Событийное хранение" является альтернативным решением.
- Для реализации реле сообщений могут использоваться два подхода: "Отслеживание журнала транзакций" и "Публикация с опросом".

Этот паттерн позволяет эффективно управлять взаимодействием между сервисами, обеспечивая согласованность данных и надежность отправки сообщений.

[Ссылка на источник](https://microservices.io/patterns/data/transactional-outbox.html)