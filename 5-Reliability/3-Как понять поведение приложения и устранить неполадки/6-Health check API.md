Паттерн "Health Check API" описывает подход к мониторингу состояния сервисов в микросервисной архитектуре, что позволяет определить, способны ли экземпляры сервисов обрабатывать запросы.

## Контекст

В микросервисной архитектуре сервисы могут продолжать работать, но при этом быть неспособными обрабатывать запросы. Например, сервис может исчерпать количество доступных соединений с базой данных. В таких случаях система мониторинга должна генерировать предупреждения, а балансировщик нагрузки или реестр сервисов не должен направлять запросы к неработающему экземпляру.

## Проблема

Как обнаружить, что работающий экземпляр сервиса не может обрабатывать запросы?

## Силы

- Должно генерироваться предупреждение, когда экземпляр сервиса выходит из строя.
- Запросы должны направляться к работающим экземплярам сервиса.

## Решение

Сервис имеет конечную точку API для проверки состояния (например, HTTP `/health`), которая возвращает здоровье сервиса. Обработчик этой конечной точки выполняет различные проверки, такие как:

- статус соединений с инфраструктурными сервисами, используемыми экземпляром сервиса;
- статус хоста, например, место на диске;
- специфическая для приложения логика.

Клиент проверки состояния — это служба мониторинга, реестр сервисов или балансировщик нагрузки — периодически вызывает эту конечную точку для проверки здоровья экземпляра сервиса.

## Примеры

Примером приложения с API проверки состояния является **Microservices Example**, написанное на Scala с использованием Spring Boot и Spring Cloud. Оно предоставляет различные возможности, включая конечную точку проверки состояния, реализованную с помощью модуля Spring Boot Actuator.Чтобы включить конечную точку `/health`, сначала необходимо определить actuator как зависимость:

```
dependencies { compile "org.springframework.boot:spring-boot-starter-actuator" }
```

Затем активируйте автоконфигурацию Spring Boot:

```
@SpringBootApplication class UserRegistrationConfiguration { }
```

Теперь ваше приложение будет иметь конечную точку проверки состояния с поведением по умолчанию. Это поведение можно настроить, определив одну или несколько Spring beans, реализующих интерфейс `HealthIndicator`:

```
@Bean def discoveryHealthIndicator(discoveryClient: EurekaClient): HealthIndicator = new DiscoveryHealthIndicator(discoveryClient)
```

`HealthIndicator` должен реализовывать метод `health()`, который возвращает значение `Health`.

## Результирующий контекст

Преимущества паттерна:

- Конечная точка проверки состояния позволяет периодически тестировать состояние экземпляра сервиса.

Недостатки:

- Проверка состояния может быть недостаточно полной или экземпляр сервиса может выйти из строя между проверками состояния, и запросы могут по-прежнему направляться к неработающему экземпляру.

## Связанные паттерны

- **Service Registry** — реестр сервисов вызывает конечную точку проверки состояния.

Этот паттерн помогает улучшить надежность системы и обеспечивает эффективный мониторинг состояния микросервисов.

[Ссылка на источник](https://microservices.io/patterns/observability/health-check-api.html)